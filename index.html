<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<title>Happy New Year</title>
<meta name="description" content="">
<meta property="og:title" content="Happy New Year">
<meta property="og:description" content="">

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000}
  canvas{position:fixed;inset:0;width:100%;height:100%;display:block}
  .hint{
    position:fixed;left:12px;top:12px;z-index:10;
    font:14px system-ui;color:#fff;opacity:.85;
    background:rgba(0,0,0,.35);padding:8px 10px;border-radius:10px
  }
</style>
</head>

<body>
<canvas id="c"></canvas>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

let W=0,H=0,dpr=1;
function resize(){
  dpr = Math.max(1, devicePixelRatio||1);
  W = innerWidth; H = innerHeight;
  canvas.width = Math.floor(W*dpr);
  canvas.height = Math.floor(H*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener('resize', resize); resize();

const rand=(a,b)=>a+Math.random()*(b-a);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

/* ================= AUDIO ================= */
let audioCtx=null, master=null;
function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  master = audioCtx.createGain();
  master.gain.value = 0.7;
  master.connect(audioCtx.destination);
}
function boomSound(intensity=1){
  if(!audioCtx) return;
  const t=audioCtx.currentTime;

  // noise
  const size = Math.floor(audioCtx.sampleRate*0.22);
  const buf = audioCtx.createBuffer(1,size,audioCtx.sampleRate);
  const data = buf.getChannelData(0);
  for(let i=0;i<size;i++){
    data[i]=(Math.random()*2-1)*Math.pow(1-i/size,2);
  }
  const noise = audioCtx.createBufferSource();
  noise.buffer=buf;

  const lp=audioCtx.createBiquadFilter();
  lp.type='lowpass';
  lp.frequency.setValueAtTime(1600,t);
  lp.frequency.exponentialRampToValueAtTime(220,t+0.2);

  const g=audioCtx.createGain();
  g.gain.setValueAtTime(0.0001,t);
  g.gain.exponentialRampToValueAtTime(0.5*intensity,t+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001,t+0.22);

  // thump
  const osc=audioCtx.createOscillator();
  osc.type='sine';
  osc.frequency.setValueAtTime(120,t);
  osc.frequency.exponentialRampToValueAtTime(45,t+0.18);

  const og=audioCtx.createGain();
  og.gain.setValueAtTime(0.0001,t);
  og.gain.exponentialRampToValueAtTime(0.25*intensity,t+0.01);
  og.gain.exponentialRampToValueAtTime(0.0001,t+0.2);

  noise.connect(lp); lp.connect(g); g.connect(master);
  osc.connect(og); og.connect(master);

  noise.start(t); noise.stop(t+0.23);
  osc.start(t); osc.stop(t+0.22);
}

/* ============== TEXT (CHẮC CHẮN HIỆN) ============== */
const MSG = "HAPPY NEW YEAR MS.LAN";
let showAt = 0;
let showUntil = 0;

// QUAN TRỌNG: nếu chữ đang chạy thì KHÔNG reset nữa
function triggerTextAfter(delayMs=3000, durationMs=3500){
  const now = performance.now();
  if (now < showUntil) return;        // đang hiện/đang chờ hiện => thôi
  showAt = now + delayMs;
  showUntil = showAt + durationMs;
}

function drawGlitterText(now){
  if(now < showAt || now > showUntil) return;

  const p = (now - showAt) / (showUntil - showAt); // 0..1
  const alphaIn  = clamp(p/0.45, 0, 1);            // fade-in từ từ
  const alphaOut = clamp((1-p)/0.25, 0, 1);
  const alpha = Math.min(alphaIn, alphaOut);

  ctx.save();
  ctx.globalCompositeOperation = 'lighter';

  // ✅ chữ NHỎ hơn
  const fontSize = Math.floor(Math.min(W,H) * 0.06); // nhỏ hơn nữa: 0.05
  ctx.font = `900 ${fontSize}px system-ui, -apple-system, Segoe UI, Roboto`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';

  const x = W*0.5;
  const y = H*0.52;

  const hue = 280; // tím
  const sparkle = 0.7 + 0.3*Math.sin(now*0.012);

  // glow mạnh để thấy rõ
  ctx.shadowColor = `hsla(${hue},100%,70%,${0.95*alpha})`;
  ctx.shadowBlur = 40;

  // viền tối kiểu “khắc”
  ctx.lineJoin = 'round';
  ctx.lineWidth = Math.max(5, fontSize*0.12);
  ctx.strokeStyle = `hsla(${hue},35%,15%,${0.9*alpha})`;
  ctx.strokeText(MSG, x, y);

  // viền sáng tím
  ctx.lineWidth = Math.max(2.5, fontSize*0.06);
  ctx.strokeStyle = `hsla(${hue},100%,82%,${0.9*alpha*sparkle})`;
  ctx.strokeText(MSG, x, y);

  // fill tím
  ctx.shadowBlur = 22;
  ctx.fillStyle = `hsla(${hue},85%,45%,${0.85*alpha})`;
  ctx.fillText(MSG, x, y);

  // kim tuyến quanh chữ
  const spreadX = fontSize*3.2;
  const spreadY = fontSize*0.8;
  for(let i=0;i<120;i++){
    const px = x + rand(-spreadX, spreadX);
    const py = y + rand(-spreadY, spreadY);
    const tw = 0.25 + 0.75*Math.abs(Math.sin(now*0.02 + i));
    const a = rand(0.06,0.22) * alpha * tw;
    ctx.fillStyle = `hsla(${hue + rand(-12,12)},100%,75%,${a})`;
    ctx.beginPath();
    ctx.arc(px, py, rand(0.6,2.0), 0, Math.PI*2);
    ctx.fill();
  }

  ctx.restore();
}

/* ============== FIREWORKS ============== */
const rockets=[], sparks=[], glitter=[];
const gravity=0.06, airDrag=0.985, sparkDrag=0.992;

function launchTo(x,y){
  const sx = rand(W*0.2, W*0.8);
  const sy = H + 10;
  const dx = x - sx, dy = y - sy;
  const t = rand(45, 75);
  rockets.push({x:sx,y:sy,vx:dx/t,vy:dy/t,hue:rand(0,360),life:t});
}

function explode(x,y,hue){
  const n  = Math.floor(rand(120, 220));
  const n2 = Math.floor(rand(50, 90));
  const baseHue = hue ?? rand(0,360);

  for(let i=0;i<n;i++){
    const a = Math.random()*Math.PI*2;
    const sp = rand(3.5, 9.5);
    sparks.push({
      x,y,
      vx: Math.cos(a)*sp,
      vy: Math.sin(a)*sp,
      hue: baseHue + rand(-15,15),
      life: rand(70, 140),
      max: 0,
      line: rand(10, 24),
      w: rand(1.2, 2.2),
    });
  }
  for(let i=0;i<n2;i++){
    const a = Math.random()*Math.PI*2;
    const sp = rand(1.5, 6);
    glitter.push({
      x,y,
      vx: Math.cos(a)*sp,
      vy: Math.sin(a)*sp,
      hue: baseHue + rand(-30,30),
      life: rand(45, 100),
      tw: rand(0.3, 1.0),
    });
  }

  const intensity = clamp(1 - (y/H), 0.35, 1);
  boomSound(intensity);

  // ✅ 3s sau mới hiện chữ (và chắc chắn hiện)
  triggerTextAfter(3000, 3500);
}

/* ===== AUTO BẮN ===== */
// bắn thưa hơn để chữ kịp hiện
setInterval(()=>{
  const x = rand(140, W-140);
  const y = rand(90, H*0.55);
  launchTo(x,y);
}, 1200);

/* ===== nền + loop ===== */
function drawBackground(){
  ctx.globalCompositeOperation='source-over';
  ctx.fillStyle='rgba(0,0,0,0.18)';
  ctx.fillRect(0,0,W,H);

  // đốm vàng lấp lánh
  ctx.globalCompositeOperation='lighter';
  for(let i=0;i<6;i++){
    const x=rand(0,W), y=rand(0,H), r=rand(1,3);
    ctx.fillStyle=`hsla(${rand(40,70)},100%,60%,${rand(0.08,0.18)})`;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }
}

function loop(now){
  drawBackground();
  ctx.globalCompositeOperation='lighter';

  // rockets
  for(let i=rockets.length-1;i>=0;i--){
    const r=rockets[i];
    const px=r.x, py=r.y;
    r.x += r.vx; r.y += r.vy;
    r.vy += gravity*0.25;
    r.life--;

    ctx.strokeStyle=`hsla(${r.hue},100%,70%,0.7)`;
    ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(r.x,r.y); ctx.stroke();

    if(r.life<=0 || r.vy>0.2){
      explode(r.x,r.y,r.hue);
      rockets.splice(i,1);
    }
  }

  // sparks
  for(let i=sparks.length-1;i>=0;i--){
    const p=sparks[i];
    if(!p.max) p.max=p.life;

    p.vx*=airDrag; p.vy*=airDrag;
    p.vy+=gravity;
    p.x+=p.vx; p.y+=p.vy;
    p.life--;

    const a=clamp(p.life/p.max,0,1);
    ctx.strokeStyle=`hsla(${p.hue},100%,70%,${a})`;
    ctx.lineWidth=p.w;

    const mag=Math.hypot(p.vx,p.vy)||1;
    const tx=(p.vx/mag)*p.line, ty=(p.vy/mag)*p.line;

    ctx.beginPath();
    ctx.moveTo(p.x,p.y);
    ctx.lineTo(p.x-tx,p.y-ty);
    ctx.stroke();

    if(p.life<=0) sparks.splice(i,1);
  }

  // glitter
  for(let i=glitter.length-1;i>=0;i--){
    const g=glitter[i];
    g.vx*=sparkDrag; g.vy*=sparkDrag;
    g.vy+=gravity*0.85;
    g.x+=g.vx; g.y+=g.vy;
    g.life--;

    const tw=0.35+0.65*Math.abs(Math.sin((g.life*0.35)*g.tw));
    const a=clamp(g.life/100,0,1)*tw;

    ctx.fillStyle=`hsla(${g.hue},100%,70%,${a})`;
    ctx.beginPath();
    ctx.arc(g.x,g.y,rand(1,2.2),0,Math.PI*2);
    ctx.fill();

    if(g.life<=0) glitter.splice(i,1);
  }

  // ✅ chữ tím
  drawGlitterText(now);

  requestAnimationFrame(loop);
}

// bật audio khi user chạm 1 lần (đúng rule trình duyệt)
addEventListener('click', ()=>{
  initAudio();
  if(audioCtx?.state==='suspended') audioCtx.resume();
}, {once:true});

ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);
requestAnimationFrame(loop);
</script>
</body>
</html>
<!-- redeploy -->



